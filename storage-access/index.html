<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Storage Access API Test Harness Site A</title>
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; line-height: 1.45; margin: 0; padding: 18px; }
    h1,h2 { margin: 0 0 10px 0; }
    p { margin: 8px 0; }
    ol { margin: 8px 0 0 22px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace; }
    .card { border: 1px solid rgba(127,127,127,0.28); border-radius: 14px; padding: 12px; margin: 12px 0; background: rgba(127,127,127,0.06); }
    .warn { border-color: rgba(200,140,0,0.8); }
    .ok { border-color: rgba(0,160,0,0.7); }
    button,a.btn {
      display: inline-block;
      padding: 8px 12px;
      border-radius: 10px;
      border: 1px solid rgba(127,127,127,0.35);
      background: rgba(127,127,127,0.12);
      color: inherit;
      text-decoration: none;
      cursor: pointer;
      margin-right: 8px;
    }
    button:hover,a.btn:hover { background: rgba(127,127,127,0.18); }
    iframe { width: 100%; height: 640px; border: 1px solid rgba(127,127,127,0.35); border-radius: 14px; background: rgba(127,127,127,0.04); }
    pre { padding: 12px; border-radius: 10px; overflow: auto; background: rgba(127,127,127,0.14); margin: 0; }
    .small { opacity: 0.85; }
  </style>
</head>
<body>
  <h1>Storage Access API Test Harness Site A</h1>

  <div class="card" id="warningCard" style="display:none;"></div>

  <div class="card">
    <div class="small">
      This page embeds Site B in an iframe, receives results via postMessage, and prints a primary status plus JSON.
    </div>
    <div class="mono small" id="context"></div>
  </div>

  <div class="card">
    <h2>Actions</h2>
    <ol>
      <li>Click <b>Open Site B seed page</b>.</li>
      <li>Return here and click <b>Reload embedded test</b> if needed.</li>
      <li>In the iframe, click <b>Run test</b>.</li>
    </ol>
    <a class="btn" id="openB" target="_blank">Open Site B seed page</a>
    <button id="reload">Reload embedded test</button>
  </div>

  <div class="card">
    <iframe id="frame" allow="storage-access"></iframe>
  </div>

  <div class="card">
    <p><b>Results</b></p>
    <pre id="log"></pre>
  </div>

  <script>
    function main() {
      const ORIGIN_B = "https://test-website-b.pages.dev";
      const PATH = "/storage-access/index.html";

      const frame = document.getElementById("frame");
      const logEl = document.getElementById("log");
      const warningCard = document.getElementById("warningCard");

      function log(line) {
        logEl.textContent += line + "\n";
        logEl.scrollTop = logEl.scrollHeight;
      }

      function randHex(nBytes) {
        try {
          const a = new Uint8Array(nBytes);
          crypto.getRandomValues(a);
          return Array.from(a).map(x => x.toString(16).padStart(2, "0")).join("");
        } catch {
          return Math.random().toString(16).slice(2) + Math.random().toString(16).slice(2);
        }
      }

      const STORAGE_TOKEN_KEY = "saa_expected_token_site_b";
      const STORAGE_SEED_CONFIRMED_KEY = "saa_seed_confirmed_site_b";

      let expectedToken = localStorage.getItem(STORAGE_TOKEN_KEY);
      if (!expectedToken) {
        expectedToken = randHex(16);
        localStorage.setItem(STORAGE_TOKEN_KEY, expectedToken);
      }

      function isSeedConfirmed() {
        return localStorage.getItem(STORAGE_SEED_CONFIRMED_KEY) === expectedToken;
      }

      function sharedHostingWarning() {
        try {
          const aHost = new URL(location.href).hostname;
          const bHost = new URL(ORIGIN_B).hostname;
          return aHost.endsWith(".pages.dev") && bHost.endsWith(".pages.dev");
        } catch {
          return false;
        }
      }

      if (sharedHostingWarning()) {
        warningCard.style.display = "block";
        warningCard.className = "card warn";
        warningCard.innerHTML =
          "<b>Context warning</b>" +
          "<div class='small'>Both sites are under pages.dev. Many engines treat these as same site. Storage Access API is meant for cross site embeds, so results can be misleading.</div>";
      }

      function buildUrls() {
        const openerOrigin = location.origin;
        const seedUrl =
          ORIGIN_B + PATH +
          "?seed=1" +
          "&token=" + encodeURIComponent(expectedToken) +
          "&openerOrigin=" + encodeURIComponent(openerOrigin);

        const embedUrl =
          ORIGIN_B + PATH +
          "?embed=1" +
          "&expectedToken=" + encodeURIComponent(expectedToken) +
          "&seedConfirmed=" + (isSeedConfirmed() ? "1" : "0") +
          "&sharedHosting=" + (sharedHostingWarning() ? "1" : "0");

        return { seedUrl, embedUrl };
      }

      function loadFrame() {
        const { embedUrl } = buildUrls();
        frame.src = embedUrl;
        log("[parent] iframe loaded " + embedUrl);
      }

      const openB = document.getElementById("openB");
      openB.href = buildUrls().seedUrl;

      document.getElementById("reload").addEventListener("click", () => {
        openB.href = buildUrls().seedUrl;
        loadFrame();
      });

      document.getElementById("context").textContent =
        "Site A origin " + location.origin +
        "   Site B origin " + ORIGIN_B +
        "   Path " + PATH +
        "   Expected token " + expectedToken +
        "   Seed confirmed " + String(isSeedConfirmed());

      window.addEventListener("message", (ev) => {
        if (ev.origin !== ORIGIN_B) return;
        const data = ev.data;
        if (!data || typeof data !== "object") return;

        if (data.type === "seedComplete") {
          if (data.token === expectedToken) {
            localStorage.setItem(STORAGE_SEED_CONFIRMED_KEY, expectedToken);
            log("[parent] seed confirmed token matched");
            document.getElementById("context").textContent =
              "Site A origin " + location.origin +
              "   Site B origin " + ORIGIN_B +
              "   Path " + PATH +
              "   Expected token " + expectedToken +
              "   Seed confirmed true";
          } else {
            log("[parent] seed message token mismatch");
          }
          return;
        }

        if (data.type === "line") log(data.line);
        if (data.type === "status") log("STATUS " + data.message);
        if (data.type === "summary") {
          log("================================");
          log("SUMMARY");
          log(JSON.stringify(data.summary, null, 2));
          log("================================");
        }
      });

      loadFrame();
    }

    main();
  </script>
</body>
</html>

